!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports):"function"==typeof define&&define.amd?define(["exports"],e):e((t="undefined"!=typeof globalThis?globalThis:t||self).monitor={})}(this,(function(t){"use strict";function e(){e=function(){return t};var t={},n=Object.prototype,r=n.hasOwnProperty,o=Object.defineProperty||function(t,e,n){t[e]=n.value},i="function"==typeof Symbol?Symbol:{},a=i.iterator||"@@iterator",u=i.asyncIterator||"@@asyncIterator",s=i.toStringTag||"@@toStringTag";function c(t,e,n){return Object.defineProperty(t,e,{value:n,enumerable:!0,configurable:!0,writable:!0}),t[e]}try{c({},"")}catch(t){c=function(t,e,n){return t[e]=n}}function l(t,e,n,r){var i=e&&e.prototype instanceof p?e:p,a=Object.create(i.prototype),u=new P(r||[]);return o(a,"_invoke",{value:x(t,n,u)}),a}function f(t,e,n){try{return{type:"normal",arg:t.call(e,n)}}catch(t){return{type:"throw",arg:t}}}t.wrap=l;var d={};function p(){}function h(){}function v(){}var y={};c(y,a,(function(){return this}));var m=Object.getPrototypeOf,b=m&&m(m(O([])));b&&b!==n&&r.call(b,a)&&(y=b);var g=v.prototype=p.prototype=Object.create(y);function w(t){["next","throw","return"].forEach((function(e){c(t,e,(function(t){return this._invoke(e,t)}))}))}function E(t,e){function n(o,i,a,u){var s=f(t[o],t,i);if("throw"!==s.type){var c=s.arg,l=c.value;return l&&"object"==typeof l&&r.call(l,"__await")?e.resolve(l.__await).then((function(t){n("next",t,a,u)}),(function(t){n("throw",t,a,u)})):e.resolve(l).then((function(t){c.value=t,a(c)}),(function(t){return n("throw",t,a,u)}))}u(s.arg)}var i;o(this,"_invoke",{value:function(t,r){function o(){return new e((function(e,o){n(t,r,e,o)}))}return i=i?i.then(o,o):o()}})}function x(t,e,n){var r="suspendedStart";return function(o,i){if("executing"===r)throw new Error("Generator is already running");if("completed"===r){if("throw"===o)throw i;return j()}for(n.method=o,n.arg=i;;){var a=n.delegate;if(a){var u=S(a,n);if(u){if(u===d)continue;return u}}if("next"===n.method)n.sent=n._sent=n.arg;else if("throw"===n.method){if("suspendedStart"===r)throw r="completed",n.arg;n.dispatchException(n.arg)}else"return"===n.method&&n.abrupt("return",n.arg);r="executing";var s=f(t,e,n);if("normal"===s.type){if(r=n.done?"completed":"suspendedYield",s.arg===d)continue;return{value:s.arg,done:n.done}}"throw"===s.type&&(r="completed",n.method="throw",n.arg=s.arg)}}}function S(t,e){var n=e.method,r=t.iterator[n];if(void 0===r)return e.delegate=null,"throw"===n&&t.iterator.return&&(e.method="return",e.arg=void 0,S(t,e),"throw"===e.method)||"return"!==n&&(e.method="throw",e.arg=new TypeError("The iterator does not provide a '"+n+"' method")),d;var o=f(r,t.iterator,e.arg);if("throw"===o.type)return e.method="throw",e.arg=o.arg,e.delegate=null,d;var i=o.arg;return i?i.done?(e[t.resultName]=i.value,e.next=t.nextLoc,"return"!==e.method&&(e.method="next",e.arg=void 0),e.delegate=null,d):i:(e.method="throw",e.arg=new TypeError("iterator result is not an object"),e.delegate=null,d)}function k(t){var e={tryLoc:t[0]};1 in t&&(e.catchLoc=t[1]),2 in t&&(e.finallyLoc=t[2],e.afterLoc=t[3]),this.tryEntries.push(e)}function L(t){var e=t.completion||{};e.type="normal",delete e.arg,t.completion=e}function P(t){this.tryEntries=[{tryLoc:"root"}],t.forEach(k,this),this.reset(!0)}function O(t){if(t){var e=t[a];if(e)return e.call(t);if("function"==typeof t.next)return t;if(!isNaN(t.length)){var n=-1,o=function e(){for(;++n<t.length;)if(r.call(t,n))return e.value=t[n],e.done=!1,e;return e.value=void 0,e.done=!0,e};return o.next=o}}return{next:j}}function j(){return{value:void 0,done:!0}}return h.prototype=v,o(g,"constructor",{value:v,configurable:!0}),o(v,"constructor",{value:h,configurable:!0}),h.displayName=c(v,s,"GeneratorFunction"),t.isGeneratorFunction=function(t){var e="function"==typeof t&&t.constructor;return!!e&&(e===h||"GeneratorFunction"===(e.displayName||e.name))},t.mark=function(t){return Object.setPrototypeOf?Object.setPrototypeOf(t,v):(t.__proto__=v,c(t,s,"GeneratorFunction")),t.prototype=Object.create(g),t},t.awrap=function(t){return{__await:t}},w(E.prototype),c(E.prototype,u,(function(){return this})),t.AsyncIterator=E,t.async=function(e,n,r,o,i){void 0===i&&(i=Promise);var a=new E(l(e,n,r,o),i);return t.isGeneratorFunction(n)?a:a.next().then((function(t){return t.done?t.value:a.next()}))},w(g),c(g,s,"Generator"),c(g,a,(function(){return this})),c(g,"toString",(function(){return"[object Generator]"})),t.keys=function(t){var e=Object(t),n=[];for(var r in e)n.push(r);return n.reverse(),function t(){for(;n.length;){var r=n.pop();if(r in e)return t.value=r,t.done=!1,t}return t.done=!0,t}},t.values=O,P.prototype={constructor:P,reset:function(t){if(this.prev=0,this.next=0,this.sent=this._sent=void 0,this.done=!1,this.delegate=null,this.method="next",this.arg=void 0,this.tryEntries.forEach(L),!t)for(var e in this)"t"===e.charAt(0)&&r.call(this,e)&&!isNaN(+e.slice(1))&&(this[e]=void 0)},stop:function(){this.done=!0;var t=this.tryEntries[0].completion;if("throw"===t.type)throw t.arg;return this.rval},dispatchException:function(t){if(this.done)throw t;var e=this;function n(n,r){return a.type="throw",a.arg=t,e.next=n,r&&(e.method="next",e.arg=void 0),!!r}for(var o=this.tryEntries.length-1;o>=0;--o){var i=this.tryEntries[o],a=i.completion;if("root"===i.tryLoc)return n("end");if(i.tryLoc<=this.prev){var u=r.call(i,"catchLoc"),s=r.call(i,"finallyLoc");if(u&&s){if(this.prev<i.catchLoc)return n(i.catchLoc,!0);if(this.prev<i.finallyLoc)return n(i.finallyLoc)}else if(u){if(this.prev<i.catchLoc)return n(i.catchLoc,!0)}else{if(!s)throw new Error("try statement without catch or finally");if(this.prev<i.finallyLoc)return n(i.finallyLoc)}}}},abrupt:function(t,e){for(var n=this.tryEntries.length-1;n>=0;--n){var o=this.tryEntries[n];if(o.tryLoc<=this.prev&&r.call(o,"finallyLoc")&&this.prev<o.finallyLoc){var i=o;break}}i&&("break"===t||"continue"===t)&&i.tryLoc<=e&&e<=i.finallyLoc&&(i=null);var a=i?i.completion:{};return a.type=t,a.arg=e,i?(this.method="next",this.next=i.finallyLoc,d):this.complete(a)},complete:function(t,e){if("throw"===t.type)throw t.arg;return"break"===t.type||"continue"===t.type?this.next=t.arg:"return"===t.type?(this.rval=this.arg=t.arg,this.method="return",this.next="end"):"normal"===t.type&&e&&(this.next=e),d},finish:function(t){for(var e=this.tryEntries.length-1;e>=0;--e){var n=this.tryEntries[e];if(n.finallyLoc===t)return this.complete(n.completion,n.afterLoc),L(n),d}},catch:function(t){for(var e=this.tryEntries.length-1;e>=0;--e){var n=this.tryEntries[e];if(n.tryLoc===t){var r=n.completion;if("throw"===r.type){var o=r.arg;L(n)}return o}}throw new Error("illegal catch attempt")},delegateYield:function(t,e,n){return this.delegate={iterator:O(t),resultName:e,nextLoc:n},"next"===this.method&&(this.arg=void 0),d}},t}function n(t){return n="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},n(t)}function r(t,e,n,r,o,i,a){try{var u=t[i](a),s=u.value}catch(t){return void n(t)}u.done?e(s):Promise.resolve(s).then(r,o)}function o(t){return function(){var e=this,n=arguments;return new Promise((function(o,i){var a=t.apply(e,n);function u(t){r(a,o,i,u,s,"next",t)}function s(t){r(a,o,i,u,s,"throw",t)}u(void 0)}))}}function i(t,e){for(var n=0;n<e.length;n++){var r=e[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(t,f(r.key),r)}}function a(t,e){return function(t){if(Array.isArray(t))return t}(t)||function(t,e){var n=null==t?null:"undefined"!=typeof Symbol&&t[Symbol.iterator]||t["@@iterator"];if(null!=n){var r,o,i,a,u=[],s=!0,c=!1;try{if(i=(n=n.call(t)).next,0===e){if(Object(n)!==n)return;s=!1}else for(;!(s=(r=i.call(n)).done)&&(u.push(r.value),u.length!==e);s=!0);}catch(t){c=!0,o=t}finally{try{if(!s&&null!=n.return&&(a=n.return(),Object(a)!==a))return}finally{if(c)throw o}}return u}}(t,e)||s(t,e)||function(){throw new TypeError("Invalid attempt to destructure non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function u(t){return function(t){if(Array.isArray(t))return c(t)}(t)||function(t){if("undefined"!=typeof Symbol&&null!=t[Symbol.iterator]||null!=t["@@iterator"])return Array.from(t)}(t)||s(t)||function(){throw new TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function s(t,e){if(t){if("string"==typeof t)return c(t,e);var n=Object.prototype.toString.call(t).slice(8,-1);return"Object"===n&&t.constructor&&(n=t.constructor.name),"Map"===n||"Set"===n?Array.from(t):"Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n)?c(t,e):void 0}}function c(t,e){(null==e||e>t.length)&&(e=t.length);for(var n=0,r=new Array(e);n<e;n++)r[n]=t[n];return r}function l(t,e){var n="undefined"!=typeof Symbol&&t[Symbol.iterator]||t["@@iterator"];if(!n){if(Array.isArray(t)||(n=s(t))||e&&t&&"number"==typeof t.length){n&&(t=n);var r=0,o=function(){};return{s:o,n:function(){return r>=t.length?{done:!0}:{done:!1,value:t[r++]}},e:function(t){throw t},f:o}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var i,a=!0,u=!1;return{s:function(){n=n.call(t)},n:function(){var t=n.next();return a=t.done,t},e:function(t){u=!0,i=t},f:function(){try{a||null==n.return||n.return()}finally{if(u)throw i}}}}function f(t){var e=function(t,e){if("object"!=typeof t||null===t)return t;var n=t[Symbol.toPrimitive];if(void 0!==n){var r=n.call(t,e||"default");if("object"!=typeof r)return r;throw new TypeError("@@toPrimitive must return a primitive value.")}return("string"===e?String:Number)(t)}(t,"string");return"symbol"==typeof e?e:String(e)}var d=function(){return d=Object.assign||function(t){for(var e,n=1,r=arguments.length;n<r;n++)for(var o in e=arguments[n])Object.prototype.hasOwnProperty.call(e,o)&&(t[o]=e[o]);return t},d.apply(this,arguments)};function p(t,e,n,r){return new(n||(n=Promise))((function(o,i){function a(t){try{s(r.next(t))}catch(t){i(t)}}function u(t){try{s(r.throw(t))}catch(t){i(t)}}function s(t){var e;t.done?o(t.value):(e=t.value,e instanceof n?e:new n((function(t){t(e)}))).then(a,u)}s((r=r.apply(t,e||[])).next())}))}function h(t,e){var n,r,o,i,a={label:0,sent:function(){if(1&o[0])throw o[1];return o[1]},trys:[],ops:[]};return i={next:u(0),throw:u(1),return:u(2)},"function"==typeof Symbol&&(i[Symbol.iterator]=function(){return this}),i;function u(u){return function(s){return function(u){if(n)throw new TypeError("Generator is already executing.");for(;i&&(i=0,u[0]&&(a=0)),a;)try{if(n=1,r&&(o=2&u[0]?r.return:u[0]?r.throw||((o=r.return)&&o.call(r),0):r.next)&&!(o=o.call(r,u[1])).done)return o;switch(r=0,o&&(u=[2&u[0],o.value]),u[0]){case 0:case 1:o=u;break;case 4:return a.label++,{value:u[1],done:!1};case 5:a.label++,r=u[1],u=[0];continue;case 7:u=a.ops.pop(),a.trys.pop();continue;default:if(!(o=a.trys,(o=o.length>0&&o[o.length-1])||6!==u[0]&&2!==u[0])){a=0;continue}if(3===u[0]&&(!o||u[1]>o[0]&&u[1]<o[3])){a.label=u[1];break}if(6===u[0]&&a.label<o[1]){a.label=o[1],o=u;break}if(o&&a.label<o[2]){a.label=o[2],a.ops.push(u);break}o[2]&&a.ops.pop(),a.trys.pop();continue}u=e.call(t,a)}catch(t){u=[6,t],r=0}finally{n=o=0}if(5&u[0])throw u[1];return{value:u[0]?u[1]:void 0,done:!0}}([u,s])}}}var v={name:"@tubefast/core",version:"1.0.1-alpha.7",description:"",main:"dist/index.min.js",scripts:{build:"rollup -c","build:watch":"rollup -c --watch"},repository:{type:"git",url:"git+https://github.com/xjq7/monitor.git"},keywords:[],author:"",license:"ISC",bugs:{url:"https://github.com/xjq7/monitor/issues"},homepage:"https://github.com/xjq7/monitor#readme",devDependencies:{"@babel/core":"^7.21.0","@babel/preset-env":"^7.20.2","@babel/preset-typescript":"^7.21.0","@rollup/plugin-babel":"^6.0.3","@rollup/plugin-json":"^6.0.0","@rollup/plugin-node-resolve":"^15.0.1","@rollup/plugin-terser":"^0.4.0","@rollup/plugin-typescript":"^11.0.0","@types/node":"^18.14.2","cross-env":"^7.0.3",emittery:"^1.0.1",jest:"^29.4.3",prettier:"^2.8.4",rimraf:"^4.1.2",rollup:"^3.17.3","rollup-plugin-clear":"^2.0.7","rollup-plugin-ts":"^3.2.0",tslib:"^2.5.0",typescript:"^4.9.5"},publishConfig:{registry:"https://repo.tuzhanai.com/repository/tuzhan-npm-release/"}};var y=function(){function t(t){var e=t.appId,n="xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,(function(t){var e=16*Math.random()|0;return("x"==t?e:3&e|8).toString(16)}));this.cache=new Map,this.baseData={appId:e,traceId:n,sdk:{version:v.version}}}return t.prototype.build=function(t){return d(d({t:+new Date},this.baseData),t)},t}(),m=0,b=function(){function t(t){this.client=t.client,this.tasks=[],this.maxPool=t.maxPool}return t.prototype.consumer=function(t){return p(this,void 0,void 0,(function(){var e,n,r=this;return h(this,(function(o){switch(o.label){case 0:if(!t&&this.tasks.length<this.maxPool)return[2];e=this.tasks.slice(0,this.maxPool),this.tasks=this.tasks.slice(this.maxPool),n=e.map((function(t){return t.data})),o.label=1;case 1:return o.trys.push([1,3,,4]),[4,this.send(n)];case 2:return o.sent(),setTimeout((function(){r.consumer()}),1e3),[3,4];case 3:return o.sent(),[3,4];case 4:return[2]}}))}))},t.prototype.push=function(t){var e={id:++m,data:t};this.tasks.push(e),this.consumer()},t.prototype.send=function(t){this.client.$hook.emit("send",(function(e){return console.log("send 任务发送: 数据",{data:t}),e(t).then((function(t){return console.log("send 成功!"),t}))}))},t.prototype.clear=function(){return p(this,void 0,void 0,(function(){return h(this,(function(t){return this.consumer(!0),[2]}))}))},t.prototype.immediate=function(t){return this.send([t])},t}(),g=new WeakMap,w=new WeakMap,E=new WeakMap,x=Symbol("anyProducer"),S=Promise.resolve(),k=Symbol("listenerAdded"),L=Symbol("listenerRemoved"),P=!1,O=!1;function j(t){if("string"!=typeof t&&"symbol"!==n(t)&&"number"!=typeof t)throw new TypeError("`eventName` must be a string, symbol, or number")}function T(t){if("function"!=typeof t)throw new TypeError("listener must be a function")}function A(t,e){var n=w.get(t);if(n.has(e))return n.get(e)}function C(t,e){var r="string"==typeof e||"symbol"===n(e)||"number"==typeof e?e:x,o=E.get(t);if(o.has(r))return o.get(r)}function I(t,e,n){var r=E.get(t);if(r.has(e)){var o,i=l(r.get(e));try{for(i.s();!(o=i.n()).done;){o.value.enqueue(n)}}catch(t){i.e(t)}finally{i.f()}}if(r.has(x)){var a,u=Promise.all([e,n]),s=l(r.get(x));try{for(s.s();!(a=s.n()).done;){a.value.enqueue(u)}}catch(t){s.e(t)}finally{s.f()}}}function R(t,n){n=Array.isArray(n)?n:[n];var r,i,a,u,s=!1,c=function(){},d=[],p={enqueue:function(t){d.push(t),c()},finish:function(){s=!0,c()}},h=l(n);try{for(h.s();!(r=h.n()).done;){var v=r.value,y=C(t,v);if(!y)y=new Set,E.get(t).set(v,y);y.add(p)}}catch(t){h.e(t)}finally{h.f()}return i={next:function(){var t=this;return o(e().mark((function n(){return e().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(d){e.next=2;break}return e.abrupt("return",{done:!0});case 2:if(0!==d.length){e.next=9;break}if(!s){e.next=6;break}return d=void 0,e.abrupt("return",t.next());case 6:return e.next=8,new Promise((function(t){c=t}));case 8:return e.abrupt("return",t.next());case 9:return e.next=11,d.shift();case 11:return e.t0=e.sent,e.abrupt("return",{done:!1,value:e.t0});case 13:case"end":return e.stop()}}),n)})))()},return:function(r){var i=arguments;return o(e().mark((function o(){var a,u,s,f;return e().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:d=void 0,a=l(n);try{for(a.s();!(u=a.n()).done;)s=u.value,(f=C(t,s))&&(f.delete(p),0===f.size&&E.get(t).delete(s))}catch(t){a.e(t)}finally{a.f()}if(c(),!(i.length>0)){e.next=11;break}return e.next=7,r;case 7:e.t1=e.sent,e.t0={done:!0,value:e.t1},e.next=12;break;case 11:e.t0={done:!0};case 12:return e.abrupt("return",e.t0);case 13:case"end":return e.stop()}}),o)})))()}},a=Symbol.asyncIterator,u=function(){return this},(a=f(a))in i?Object.defineProperty(i,a,{value:u,enumerable:!0,configurable:!0,writable:!0}):i[a]=u,i}function D(t){if(void 0===t)return _;if(!Array.isArray(t))throw new TypeError("`methodNames` must be an array of strings");var e,n=l(t);try{for(n.s();!(e=n.n()).done;){var r=e.value;if(!_.includes(r)){if("string"!=typeof r)throw new TypeError("`methodNames` element must be a string");throw new Error("".concat(r," is not Emittery method"))}}}catch(t){n.e(t)}finally{n.f()}return t}var N=function(t){return t===k||t===L};function M(t,e,n){if(N(e))try{P=!0,t.emit(e,n)}finally{P=!1}}var q=function(){function t(){var e,r=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};!function(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}(this,t),g.set(this,new Set),w.set(this,new Map),E.set(this,new Map),E.get(this).set(x,new Set),this.debug=null!==(e=r.debug)&&void 0!==e?e:{},void 0===this.debug.enabled&&(this.debug.enabled=!1),this.debug.logger||(this.debug.logger=function(t,e,r,o){try{o=JSON.stringify(o)}catch(t){o="Object with the following keys failed to stringify: ".concat(Object.keys(o).join(","))}"symbol"!==n(r)&&"number"!=typeof r||(r=r.toString());var i=new Date,a="".concat(i.getHours(),":").concat(i.getMinutes(),":").concat(i.getSeconds(),".").concat(i.getMilliseconds());console.log("[".concat(a,"][emittery:").concat(t,"][").concat(e,"] Event Name: ").concat(r,"\n\tdata: ").concat(o))})}var r,s,c,f,d;return r=t,s=[{key:"logIfDebugEnabled",value:function(e,n,r){(t.isDebugEnabled||this.debug.enabled)&&this.debug.logger(e,this.debug.name,n,r)}},{key:"on",value:function(t,e){T(e);var n,r=l(t=Array.isArray(t)?t:[t]);try{for(r.s();!(n=r.n()).done;){var o=n.value;j(o);var i=A(this,o);i||(i=new Set,w.get(this).set(o,i)),i.add(e),this.logIfDebugEnabled("subscribe",o,void 0),N(o)||M(this,k,{eventName:o,listener:e})}}catch(t){r.e(t)}finally{r.f()}return this.off.bind(this,t,e)}},{key:"off",value:function(t,e){T(e);var n,r=l(t=Array.isArray(t)?t:[t]);try{for(r.s();!(n=r.n()).done;){var o=n.value;j(o);var i=A(this,o);i&&(i.delete(e),0===i.size&&w.get(this).delete(o)),this.logIfDebugEnabled("unsubscribe",o,void 0),N(o)||M(this,L,{eventName:o,listener:e})}}catch(t){r.e(t)}finally{r.f()}}},{key:"once",value:function(t){var e,n=this,r=new Promise((function(r){e=n.on(t,(function(t){e(),r(t)}))}));return r.off=e,r}},{key:"events",value:function(t){var e,n=l(t=Array.isArray(t)?t:[t]);try{for(n.s();!(e=n.n()).done;)j(e.value)}catch(t){n.e(t)}finally{n.f()}return R(this,t)}},{key:"emit",value:(d=o(e().mark((function t(n,r){var i,a,s,c,l;return e().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:if(j(n),!N(n)||P){t.next=3;break}throw new TypeError("`eventName` cannot be meta event `listenerAdded` or `listenerRemoved`");case 3:return this.logIfDebugEnabled("emit",n,r),I(this,n,r),a=null!==(i=A(this,n))&&void 0!==i?i:new Set,s=g.get(this),c=u(a),l=N(n)?[]:u(s),t.next=11,S;case 11:return t.next=13,Promise.all([].concat(u(c.map(function(){var t=o(e().mark((function t(n){return e().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:if(!a.has(n)){t.next=2;break}return t.abrupt("return",n(r));case 2:case"end":return t.stop()}}),t)})));return function(e){return t.apply(this,arguments)}}())),u(l.map(function(){var t=o(e().mark((function t(o){return e().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:if(!s.has(o)){t.next=2;break}return t.abrupt("return",o(n,r));case 2:case"end":return t.stop()}}),t)})));return function(e){return t.apply(this,arguments)}}()))));case 13:case"end":return t.stop()}}),t,this)}))),function(t,e){return d.apply(this,arguments)})},{key:"emitSerial",value:(f=o(e().mark((function t(n,r){var o,i,a,s,c,f,d,p,h,v,y;return e().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:if(j(n),!N(n)||P){t.next=3;break}throw new TypeError("`eventName` cannot be meta event `listenerAdded` or `listenerRemoved`");case 3:return this.logIfDebugEnabled("emitSerial",n,r),i=null!==(o=A(this,n))&&void 0!==o?o:new Set,a=g.get(this),s=u(i),c=u(a),t.next=10,S;case 10:f=l(s),t.prev=11,f.s();case 13:if((d=f.n()).done){t.next=20;break}if(p=d.value,!i.has(p)){t.next=18;break}return t.next=18,p(r);case 18:t.next=13;break;case 20:t.next=25;break;case 22:t.prev=22,t.t0=t.catch(11),f.e(t.t0);case 25:return t.prev=25,f.f(),t.finish(25);case 28:h=l(c),t.prev=29,h.s();case 31:if((v=h.n()).done){t.next=38;break}if(y=v.value,!a.has(y)){t.next=36;break}return t.next=36,y(n,r);case 36:t.next=31;break;case 38:t.next=43;break;case 40:t.prev=40,t.t1=t.catch(29),h.e(t.t1);case 43:return t.prev=43,h.f(),t.finish(43);case 46:case"end":return t.stop()}}),t,this,[[11,22,25,28],[29,40,43,46]])}))),function(t,e){return f.apply(this,arguments)})},{key:"onAny",value:function(t){return T(t),this.logIfDebugEnabled("subscribeAny",void 0,void 0),g.get(this).add(t),M(this,k,{listener:t}),this.offAny.bind(this,t)}},{key:"anyEvent",value:function(){return R(this)}},{key:"offAny",value:function(t){T(t),this.logIfDebugEnabled("unsubscribeAny",void 0,void 0),M(this,L,{listener:t}),g.get(this).delete(t)}},{key:"clearListeners",value:function(t){var e,r=l(t=Array.isArray(t)?t:[t]);try{for(r.s();!(e=r.n()).done;){var o=e.value;if(this.logIfDebugEnabled("clear",o,void 0),"string"==typeof o||"symbol"===n(o)||"number"==typeof o){var i=A(this,o);i&&i.clear();var u=C(this,o);if(u){var s,c=l(u);try{for(c.s();!(s=c.n()).done;)s.value.finish()}catch(t){c.e(t)}finally{c.f()}u.clear()}}else{g.get(this).clear();var f,d=l(w.get(this).entries());try{for(d.s();!(f=d.n()).done;){var p=a(f.value,2),h=p[0];p[1].clear(),w.get(this).delete(h)}}catch(t){d.e(t)}finally{d.f()}var v,y=l(E.get(this).entries());try{for(y.s();!(v=y.n()).done;){var m,b=a(v.value,2),x=b[0],S=b[1],k=l(S);try{for(k.s();!(m=k.n()).done;)m.value.finish()}catch(t){k.e(t)}finally{k.f()}S.clear(),E.get(this).delete(x)}}catch(t){y.e(t)}finally{y.f()}}}}catch(t){r.e(t)}finally{r.f()}}},{key:"listenerCount",value:function(t){var e,n=0,r=l(t=Array.isArray(t)?t:[t]);try{for(r.s();!(e=r.n()).done;){var o=e.value;if("string"!=typeof o){void 0!==o&&j(o),n+=g.get(this).size;var i,a=l(w.get(this).values());try{for(a.s();!(i=a.n()).done;)n+=i.value.size}catch(t){a.e(t)}finally{a.f()}var u,s=l(E.get(this).values());try{for(s.s();!(u=s.n()).done;)n+=u.value.size}catch(t){s.e(t)}finally{s.f()}}else{var c,f,d,p,h,v;n+=g.get(this).size+(null!==(c=null===(f=A(this,o))||void 0===f?void 0:f.size)&&void 0!==c?c:0)+(null!==(d=null===(p=C(this,o))||void 0===p?void 0:p.size)&&void 0!==d?d:0)+(null!==(h=null===(v=C(this))||void 0===v?void 0:v.size)&&void 0!==h?h:0)}}}catch(t){r.e(t)}finally{r.f()}return n}},{key:"bindMethods",value:function(t,e){if("object"!==n(t)||null===t)throw new TypeError("`target` must be an object");var r,o=l(e=D(e));try{for(o.s();!(r=o.n()).done;){var i=r.value;if(void 0!==t[i])throw new Error("The property `".concat(i,"` already exists on `target`"));Object.defineProperty(t,i,{enumerable:!1,value:this[i].bind(this)})}}catch(t){o.e(t)}finally{o.f()}}}],c=[{key:"mixin",value:function(e,n){return n=D(n),function(r){if("function"!=typeof r)throw new TypeError("`target` must be function");var o,i=l(n);try{for(i.s();!(o=i.n()).done;){var a=o.value;if(void 0!==r.prototype[a])throw new Error("The property `".concat(a,"` already exists on `target`"))}}catch(t){i.e(t)}finally{i.f()}Object.defineProperty(r.prototype,e,{enumerable:!1,get:function(){return Object.defineProperty(this,e,{enumerable:!1,value:new t}),this[e]}});var u,s=function(t){return function(){var n;return(n=this[e])[t].apply(n,arguments)}},c=l(n);try{for(c.s();!(u=c.n()).done;){var f=u.value;Object.defineProperty(r.prototype,f,{enumerable:!1,value:s(f)})}}catch(t){c.e(t)}finally{c.f()}return r}}},{key:"isDebugEnabled",get:function(){var t,e;if("object"!==n(null===(t=globalThis.process)||void 0===t?void 0:t.env))return O;var r=(null!==(e=globalThis.process)&&void 0!==e?e:{env:{}}).env;return"emittery"===r.DEBUG||"*"===r.DEBUG||O},set:function(t){O=t}}],s&&i(r.prototype,s),c&&i(r,c),Object.defineProperty(r,"prototype",{writable:!1}),t}(),_=Object.getOwnPropertyNames(q.prototype).filter((function(t){return"constructor"!==t}));Object.defineProperty(q,"listenerAdded",{value:k,writable:!1,enumerable:!0,configurable:!1}),Object.defineProperty(q,"listenerRemoved",{value:L,writable:!1,enumerable:!0,configurable:!1});var F,G,H,z=function(){function t(){}return t.prototype.init=function(t){var e;!function(t){if(!t)throw new Error("缺少 SDK 配置信息");if(!t.dsn)throw new Error("缺少 SDK dns 配置信息");if(!t.appId)throw new Error("缺少 appId 应用 ID")}(t),this.config=t;var n=t.plugins,r=void 0===n?[]:n,o=t.appId,i=t.maxPool,a=void 0===i?10:i;this.builder=new y({appId:o}),this.schedule=new b({maxPool:a,client:this}),this.$hook=new q,this.registerPlugins(r),this.addListeners(),null===(e=this.$hook)||void 0===e||e.emit("init",{})},t.prototype.registerPlugins=function(t){var e=this;Array.isArray(t)&&t.map((function(t){return t.apply(e)}))},t.prototype.addListeners=function(){var t,e=this;null===(t=this.$hook)||void 0===t||t.on("report",(function(t){var n,r,o,i=t.data,a=t.runTime;console.log("report 事件触发, 数据:",i);var u=null===(n=e.builder)||void 0===n?void 0:n.build(i);u&&(a&&"delay"!==a?"immediately"===a&&(null===(o=e.schedule)||void 0===o||o.immediate(u)):null===(r=e.schedule)||void 0===r||r.push(u))}))},t.prototype.getReportParams=function(){return{url:this.config.dsn+"/v1/report",method:"POST",headers:{}}},t.prototype.getTasks=function(){return this.schedule.tasks},t.prototype.getConfig=function(){return this.config},t}();!function(t){t.PERFORMANCE="1",t.RESOURCE="2",t.ERROR="3"}(F||(F={})),function(t){t[t.PROMISE=0]="PROMISE",t[t.JS=1]="JS",t[t.RESOURCE=2]="RESOURCE"}(G||(G={})),function(t){t[t.fetch=0]="fetch",t[t.XHR=1]="XHR"}(H||(H={}));var X=function(){function t(t){this.name="Browser",this.options=t||{}}return t.prototype.apply=function(t){var e=this;this.client=t,window&&(t.$hook.on("init",(function(){console.log("init 事件触发"),e.timing(),e.listenError(),e.promiseError(),e.overrideFetch(),e.overrideXHR()})),t.$hook.on("send",(function(t){requestIdleCallback((function(){return t(e.send.bind(e))}))})),window.addEventListener("unload",(function(){var n=t.getTasks().map((function(t){return t.data}));e.send(n)})))},t.prototype.send=function(t){var e=this.client.getReportParams(),n=e.url,r=e.method,o=new FormData;return o.append("data",JSON.stringify(t)),"function"==typeof navigator.sendBeacon?Promise.resolve(navigator.sendBeacon(n,o)):"function"==typeof fetch?fetch(n,{method:r,keepalive:!0}).then((function(){return!0})):new Promise((function(t,e){var i=new XMLHttpRequest;i.addEventListener("load",(function(){t(!0)})),i.addEventListener("error",(function(){e()})),i.open(r,n),i.send(o)}))},t.prototype.report=function(t){var e,n=t.data,r=n.eid,o=n.l,i=navigator.userAgent;null===(e=this.client)||void 0===e||e.$hook.emit("report",d(d({},t),{data:{eid:r,l:d(d({},o),{ua:i})}}))},t.prototype.overrideXHR=function(){var t=this.client;if(XMLHttpRequest){var e=XMLHttpRequest.prototype.open,n=XMLHttpRequest.prototype.send;XMLHttpRequest.prototype.open=function(){for(var t=[],n=0;n<arguments.length;n++)t[n]=arguments[n];var r=t[0],o=t[1],i=Date.now();this.reporterCollect=d(d({},this.reporterCollect),{method:r,url:o,startTime:i,type:H.XHR}),e.apply(this,t)},XMLHttpRequest.prototype.send=function(){for(var e=this,r=[],o=0;o<arguments.length;o++)r[o]=arguments[o];this.addEventListener("loadend",(function(){var n=Date.now(),r=e,o=r.status,i=r.statusText;o>200&&(e.reporterCollect=d(d({},e.reporterCollect),{endTime:n,status:o,statusText:i}),null==t||t.$hook.emit("report",{data:{eid:"1001",l:e.reporterCollect}}))})),n.apply(this,r)}}},t.prototype.overrideFetch=function(){if("function"==typeof window.fetch){var t=this,e=window.fetch;window.fetch=function(){for(var n=[],r=0;r<arguments.length;r++)n[r]=arguments[r];var o=Date.now(),i=n[0],a=(n[1]||{}).method,u={url:i,startTime:o,method:void 0===a?"GET":a,type:H.fetch};return e.apply(window,n).then((function(e){var n=e.status,r=e.statusText;if(n&&n>300){var o=Date.now();Object.assign(u,{status:n,statusText:r,endTime:o}),t.report({data:{eid:"1001",l:u}})}return e})).catch((function(e){var n=Date.now(),r=e.name,o=e.message,i=e.stack;return Object.assign(u,{name:r,message:o,stack:i}),u.endTime=n,t.report({data:{eid:"1001",l:u}}),e}))}}},t.prototype.listenError=function(){var t=this;window.addEventListener("error",(function(e){var n=e.type,r=e.error,o=e.colno,i=e.filename,a=e.lineno,u=e.message;"error"===n&&i&&o&&a&&(u||(u=(null==r?void 0:r.message)||""),t.report({data:{eid:"1003",l:{colno:o,message:u,filename:i,lineno:a,stack:null==r?void 0:r.stack,type:G.JS}}}))}),!0)},t.prototype.promiseError=function(){var t=this;window.addEventListener("unhandledrejection",(function(e){var n=e.reason,r={message:"",stack:"",name:""};if("string"==typeof n)r.message=n;else if(n instanceof Error){var o=n.name,i=n.stack,a=n.message;r.message=a,r.stack=i||"",r.name=o}t.report({data:{eid:"1003",l:d({type:G.PROMISE},r)}})}))},t.prototype.timing=function(){var t=this,e={};if(PerformanceObserver){var n=new Promise((function(t,e){new PerformanceObserver((function(e){e.getEntries().forEach((function(e){"first-contentful-paint"===e.name&&t(e.startTime)}))})).observe({type:"paint",buffered:!0})})),r=new Promise((function(t,e){new PerformanceObserver((function(e){var n=e.getEntries(),r=n[n.length-1];t(r.startTime)})).observe({type:"largest-contentful-paint",buffered:!0})})),o=new Promise((function(t,e){new PerformanceObserver((function(e){e.getEntries().forEach((function(e){if("navigation"===e.entryType){var n=e.toJSON();t(n)}}))})).observe({entryTypes:["navigation"]})}));Promise.all([o,r,n]).then((function(e){var n=e[0],r=e[1],o=e[2],i=t.formatTiming(n);t.report({runTime:"immediately",data:{eid:"1000",l:d(d({},i),{lcp:Number(r.toFixed(2)),fcp:Number(o.toFixed(2))})}})}))}else window.addEventListener("load",(function(){var n=performance.timing,r=n.unloadEventStart,o=n.unloadEventEnd,i=n.navigationStart,a=n.redirectStart,u=n.redirectEnd,s=n.fetchStart,c=n.domainLookupStart,l=n.domainLookupEnd,f=n.connectStart,d=n.secureConnectionStart,p=n.connectEnd,h=n.requestStart,v=n.responseStart,y=n.responseEnd,m=n.domLoading,b=n.domInteractive,g=n.domContentLoadedEventEnd,w=n.domContentLoadedEventStart,E=n.domComplete,x=n.loadEventStart,S=n.loadEventEnd,k=performance.navigation.redirectCount,L=i||0;r=r>=L?r-L:0,o=o>=L?o-L:r,a=a>=L?a-L:o,u=u>=L?u-L:a,s=s>=L?s-L:u,l=(c=c>=L?c-L:s)>=L?c-L:c,f=f>=L?f-L:l,d=d>=L?d-L:f,p=p>=L?p-L:d,h=h?h-L:p,v=v>=L?v-L:h,y=y>=L?y-L:v,m=m>=L?m-L:y,b=b>=L?b-L:m,w=w>=L?w-L:b,e={navigationStart:0,unloadEventStart:r,unloadEventEnd:o,redirectStart:a,redirectEnd:u,fetchStart:s,domainLookupStart:c,domainLookupEnd:l,connectStart:f,secureConnectionStart:d,connectEnd:p,requestStart:h,responseStart:v,responseEnd:y,domLoading:m,domInteractive:b,domContentLoadedEventEnd:g=g>=L?g-L:w,domContentLoadedEventStart:w,domComplete:E=E>=L?E-L:g,loadEventStart:x=x>=L?x-L:E,loadEventEnd:S=S>=L?S-L:x,redirectCount:k},t.report({runTime:"immediately",data:{eid:"1000",l:e}})}))},t.prototype.formatTiming=function(t){var e={unloadEventStart:t.unloadEventStart,unloadEventEnd:t.unloadEventEnd,navigationStart:t.navigationStart,redirectStart:t.redirectStart,redirectEnd:t.redirectEnd,redirectCount:t.redirectCount,fetchStart:t.fetchStart,domainLookupStart:t.domainLookupStart,domainLookupEnd:t.domainLookupEnd,connectStart:t.connectStart,secureConnectionStart:t.secureConnectionStart,connectEnd:t.connectEnd,requestStart:t.requestStart,responseStart:t.responseStart,responseEnd:t.responseEnd,domLoading:t.domLoading,domInteractive:t.domInteractive,domContentLoadedEventEnd:t.domContentLoadedEventEnd,domContentLoadedEventStart:t.domContentLoadedEventStart,domComplete:t.domComplete,loadEventStart:t.loadEventStart,loadEventEnd:t.loadEventEnd};return Object.entries(e).forEach((function(t){var n=t[0],r=t[1];e[n]="number"==typeof r?Number(r.toFixed(2)):r||0})),e},t}();t.Browser=X,t.default=z,Object.defineProperty(t,"__esModule",{value:!0})}));
