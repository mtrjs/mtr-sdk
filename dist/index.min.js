!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports):"function"==typeof define&&define.amd?define(["exports"],e):e((t="undefined"!=typeof globalThis?globalThis:t||self).monitor={})}(this,(function(t){"use strict";function e(t){return e="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},e(t)}function n(t,e){for(var n=0;n<e.length;n++){var r=e[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(t,o(r.key),r)}}function r(t,e,n){return(e=o(e))in t?Object.defineProperty(t,e,{value:n,enumerable:!0,configurable:!0,writable:!0}):t[e]=n,t}function o(t){var e=function(t,e){if("object"!=typeof t||null===t)return t;var n=t[Symbol.toPrimitive];if(void 0!==n){var r=n.call(t,e||"default");if("object"!=typeof r)return r;throw new TypeError("@@toPrimitive must return a primitive value.")}return("string"===e?String:Number)(t)}(t,"string");return"symbol"==typeof e?e:String(e)}var i=function(){return i=Object.assign||function(t){for(var e,n=1,r=arguments.length;n<r;n++)for(var o in e=arguments[n])Object.prototype.hasOwnProperty.call(e,o)&&(t[o]=e[o]);return t},i.apply(this,arguments)};function a(t,e,n,r){return new(n||(n=Promise))((function(o,i){function a(t){try{u(r.next(t))}catch(t){i(t)}}function s(t){try{u(r.throw(t))}catch(t){i(t)}}function u(t){var e;t.done?o(t.value):(e=t.value,e instanceof n?e:new n((function(t){t(e)}))).then(a,s)}u((r=r.apply(t,e||[])).next())}))}function s(t,e){var n,r,o,i,a={label:0,sent:function(){if(1&o[0])throw o[1];return o[1]},trys:[],ops:[]};return i={next:s(0),throw:s(1),return:s(2)},"function"==typeof Symbol&&(i[Symbol.iterator]=function(){return this}),i;function s(s){return function(u){return function(s){if(n)throw new TypeError("Generator is already executing.");for(;i&&(i=0,s[0]&&(a=0)),a;)try{if(n=1,r&&(o=2&s[0]?r.return:s[0]?r.throw||((o=r.return)&&o.call(r),0):r.next)&&!(o=o.call(r,s[1])).done)return o;switch(r=0,o&&(s=[2&s[0],o.value]),s[0]){case 0:case 1:o=s;break;case 4:return a.label++,{value:s[1],done:!1};case 5:a.label++,r=s[1],s=[0];continue;case 7:s=a.ops.pop(),a.trys.pop();continue;default:if(!(o=a.trys,(o=o.length>0&&o[o.length-1])||6!==s[0]&&2!==s[0])){a=0;continue}if(3===s[0]&&(!o||s[1]>o[0]&&s[1]<o[3])){a.label=s[1];break}if(6===s[0]&&a.label<o[1]){a.label=o[1],o=s;break}if(o&&a.label<o[2]){a.label=o[2],a.ops.push(s);break}o[2]&&a.ops.pop(),a.trys.pop();continue}s=e.call(t,a)}catch(t){s=[6,t],r=0}finally{n=o=0}if(5&s[0])throw s[1];return{value:s[0]?s[1]:void 0,done:!0}}([s,u])}}}var u={name:"@tubefast/core",version:"1.0.1-alpha.7",description:"",main:"dist/index.min.js",scripts:{build:"rollup -c","build:watch":"rollup -c --watch"},repository:{type:"git",url:"git+https://github.com/xjq7/monitor.git"},keywords:[],author:"",license:"ISC",bugs:{url:"https://github.com/xjq7/monitor/issues"},homepage:"https://github.com/xjq7/monitor#readme",devDependencies:{"@babel/core":"^7.21.0","@babel/preset-env":"^7.20.2","@babel/preset-typescript":"^7.21.0","@rollup/plugin-babel":"^6.0.3","@rollup/plugin-json":"^6.0.0","@rollup/plugin-node-resolve":"^15.0.1","@rollup/plugin-terser":"^0.4.0","@rollup/plugin-typescript":"^11.0.0","@types/node":"^18.14.2","cross-env":"^7.0.3",prettier:"^2.8.4",rimraf:"^4.1.2",rollup:"^3.17.3","rollup-plugin-clear":"^2.0.7",tslib:"^2.5.0",typescript:"^4.9.5","@tubit/common":"^1.5.1",jest:"^29.4.3","rollup-plugin-ts":"^3.2.0"},dependencies:{},publishConfig:{registry:"https://repo.tuzhanai.com/repository/tuzhan-npm-release/"}};var l=function(){function t(t){var e=t.appId,n="xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,(function(t){var e=16*Math.random()|0;return("x"==t?e:3&e|8).toString(16)}));this.cache=new Map,this.baseData={appId:e,traceId:n,sdk:{version:u.version}}}return t.prototype.build=function(t){return i(i({t:+new Date},this.baseData),t)},t}(),c=0,d=function(){function t(t){this.client=t.client,this.tasks=[],this.maxPool=t.maxPool}return t.prototype.consumer=function(t){return a(this,void 0,void 0,(function(){var e,n,r=this;return s(this,(function(o){switch(o.label){case 0:if(!t&&this.tasks.length<this.maxPool)return[2];e=this.tasks.slice(0,this.maxPool),this.tasks=this.tasks.slice(this.maxPool),n=e.map((function(t){return t.data})),o.label=1;case 1:return o.trys.push([1,3,,4]),[4,this.send(n)];case 2:return o.sent(),setTimeout((function(){r.consumer()}),1e3),[3,4];case 3:return o.sent(),[3,4];case 4:return[2]}}))}))},t.prototype.push=function(t){var e={id:++c,data:t};this.tasks.push(e),this.consumer()},t.prototype.send=function(t){this.client.$hook.emit("send",(function(e){return console.log("send 任务发送: 数据",{data:t}),e(t).then((function(t){return console.log("send 成功!"),t}))}))},t.prototype.clear=function(){return a(this,void 0,void 0,(function(){return s(this,(function(t){return this.consumer(!0),[2]}))}))},t.prototype.immediate=function(t){return this.send([t])},t}();function p(t){return function(e,n,r){return e[t]=r.value,r}}var f=function(t,n,r,o){var i,a=arguments.length,s=a<3?n:null===o?o=Object.getOwnPropertyDescriptor(n,r):o;if("object"===("undefined"==typeof Reflect?"undefined":e(Reflect))&&"function"==typeof Reflect.decorate)s=Reflect.decorate(t,n,r,o);else for(var u=t.length-1;u>=0;u--)(i=t[u])&&(s=(a<3?i(s):a>3?i(n,r,s):i(n,r))||s);return a>3&&s&&Object.defineProperty(n,r,s),s},v=function(){function t(){!function(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}(this,t),r(this,"lastEmittedEvents",new Map),r(this,"eventListeners",new Map)}var e,o,i;return e=t,o=[{key:"addListener",value:function(t,e){var n=arguments.length>2&&void 0!==arguments[2]&&arguments[2];if(t&&e){var r=this.eventListeners.get(t);r||(r=[],this.eventListeners.set(t,r)),r.indexOf(e)>=0||(r.push(e),n&&this.lastEmittedEvents.has(t)&&e(this.lastEmittedEvents.get(t)))}}},{key:"addOnceListener",value:function(t,e){var n=this,r=arguments.length>2&&void 0!==arguments[2]&&arguments[2];this.on(t,(function r(o){e(o),n.off(t,r)}),r)}},{key:"removeListener",value:function(t,e){if(t)if(e){for(var n=this.listeners(t),r=0;r<n.length;r++)if(n[r]===e){n.splice(r,1);break}}else this.eventListeners.set(t,[]);else this.removeAllListeners()}},{key:"removeAllListeners",value:function(){this.lastEmittedEvents.clear(),this.eventListeners.clear()}},{key:"emit",value:function(t,e){if(t){for(var n=this.listeners(t),r=n.length;r;)(0,n[n.length-r])(e),r--;this.lastEmittedEvents.set(t,e)}}},{key:"listeners",value:function(t){return this.eventListeners.get(t)||[]}},{key:"listenerCount",value:function(t){return this.listeners(t).length}}],o&&n(e.prototype,o),i&&n(e,i),Object.defineProperty(e,"prototype",{writable:!1}),t}();f([p("on")],v.prototype,"addListener",null),f([p("once")],v.prototype,"addOnceListener",null),f([p("off")],v.prototype,"removeListener",null),f([p("offAll")],v.prototype,"removeAllListeners",null),f([p("fire")],v.prototype,"emit",null);var h=window.__globalEvent__;h||(window.__globalEvent__=new v,h=window.__globalEvent__);var m,y,g,E=function(){function t(){}return t.prototype.init=function(t){var e;!function(t){if(!t)throw new Error("缺少 SDK 配置信息");if(!t.dsn)throw new Error("缺少 SDK dns 配置信息");if(!t.appId)throw new Error("缺少 appId 应用 ID")}(t),this.config=t;var n=t.plugins,r=void 0===n?[]:n,o=t.appId,i=t.maxPool,a=void 0===i?10:i;this.builder=new l({appId:o}),this.schedule=new d({maxPool:a,client:this}),this.$hook=new v,this.registerPlugins(r),this.addListeners(),null===(e=this.$hook)||void 0===e||e.emit("init",{})},t.prototype.registerPlugins=function(t){var e=this;Array.isArray(t)&&t.map((function(t){return t.apply(e)}))},t.prototype.addListeners=function(){var t,e=this;null===(t=this.$hook)||void 0===t||t.on("report",(function(t){var n,r,o,i=t.data,a=t.runTime;console.log("report 事件触发, 数据:",i);var s=null===(n=e.builder)||void 0===n?void 0:n.build(i);s&&(a&&"delay"!==a?"immediately"===a&&(null===(o=e.schedule)||void 0===o||o.immediate(s)):null===(r=e.schedule)||void 0===r||r.push(s))}))},t.prototype.getReportParams=function(){return{url:this.config.dsn+"/v1/report",method:"POST",headers:{}}},t.prototype.getTasks=function(){return this.schedule.tasks},t.prototype.getConfig=function(){return this.config},t}();!function(t){t.PERFORMANCE="1",t.RESOURCE="2",t.ERROR="3"}(m||(m={})),function(t){t[t.PROMISE=0]="PROMISE",t[t.JS=1]="JS",t[t.RESOURCE=2]="RESOURCE"}(y||(y={})),function(t){t[t.fetch=0]="fetch",t[t.XHR=1]="XHR"}(g||(g={}));var b=function(){function t(t){this.name="Browser",this.options=t||{}}return t.prototype.apply=function(t){var e=this;this.client=t,window&&(t.$hook.on("init",(function(){console.log("init 事件触发"),e.timing(),e.listenError(),e.promiseError(),e.overrideFetch(),e.overrideXHR()})),t.$hook.on("send",(function(t){requestIdleCallback((function(){return t(e.send.bind(e))}))})),window.addEventListener("unload",(function(){var n=t.getTasks().map((function(t){return t.data}));e.send(n)})))},t.prototype.send=function(t){var e=this.client.getReportParams(),n=e.url,r=e.method,o=new FormData;return o.append("data",JSON.stringify(t)),"function"==typeof navigator.sendBeacon?Promise.resolve(navigator.sendBeacon(n,o)):"function"==typeof fetch?fetch(n,{method:r,keepalive:!0}).then((function(){return!0})):new Promise((function(t,e){var i=new XMLHttpRequest;i.addEventListener("load",(function(){t(!0)})),i.addEventListener("error",(function(){e()})),i.open(r,n),i.send(o)}))},t.prototype.report=function(t){var e,n=t.data,r=n.eid,o=n.l,a=navigator.userAgent;null===(e=this.client)||void 0===e||e.$hook.emit("report",i(i({},t),{data:{eid:r,l:i(i({},o),{ua:a})}}))},t.prototype.overrideXHR=function(){var t=this.client;if(XMLHttpRequest){var e=XMLHttpRequest.prototype.open,n=XMLHttpRequest.prototype.send;XMLHttpRequest.prototype.open=function(){for(var t=[],n=0;n<arguments.length;n++)t[n]=arguments[n];var r=t[0],o=t[1],a=Date.now();this.reporterCollect=i(i({},this.reporterCollect),{method:r,url:o,startTime:a,type:g.XHR}),e.apply(this,t)},XMLHttpRequest.prototype.send=function(){for(var e=this,r=[],o=0;o<arguments.length;o++)r[o]=arguments[o];this.addEventListener("loadend",(function(){var n=Date.now(),r=e,o=r.status,a=r.statusText;o>200&&(e.reporterCollect=i(i({},e.reporterCollect),{endTime:n,status:o,statusText:a}),null==t||t.$hook.emit("report",{data:{eid:"1001",l:e.reporterCollect}}))})),n.apply(this,r)}}},t.prototype.overrideFetch=function(){if("function"==typeof window.fetch){var t=this,e=window.fetch;window.fetch=function(){for(var n=[],r=0;r<arguments.length;r++)n[r]=arguments[r];var o=Date.now(),i=n[0],a=(n[1]||{}).method,s={url:i,startTime:o,method:void 0===a?"GET":a,type:g.fetch};return e.apply(window,n).then((function(e){var n=e.status,r=e.statusText;if(n&&n>300){var o=Date.now();Object.assign(s,{status:n,statusText:r,endTime:o}),t.report({data:{eid:"1001",l:s}})}return e})).catch((function(e){var n=Date.now(),r=e.name,o=e.message,i=e.stack;return Object.assign(s,{name:r,message:o,stack:i}),s.endTime=n,t.report({data:{eid:"1001",l:s}}),e}))}}},t.prototype.listenError=function(){var t=this;window.addEventListener("error",(function(e){var n=e.type,r=e.error,o=e.colno,i=e.filename,a=e.lineno,s=e.message;"error"===n&&i&&o&&a&&(s||(s=(null==r?void 0:r.message)||""),t.report({data:{eid:"1003",l:{colno:o,message:s,filename:i,lineno:a,stack:null==r?void 0:r.stack,type:y.JS}}}))}),!0)},t.prototype.promiseError=function(){var t=this;window.addEventListener("unhandledrejection",(function(e){var n=e.reason,r={message:"",stack:"",name:""};if("string"==typeof n)r.message=n;else if(n instanceof Error){var o=n.name,a=n.stack,s=n.message;r.message=s,r.stack=a||"",r.name=o}t.report({data:{eid:"1003",l:i({type:y.PROMISE},r)}})}))},t.prototype.timing=function(){var t=this,e={};if(PerformanceObserver){var n=new Promise((function(t,e){new PerformanceObserver((function(e){e.getEntries().forEach((function(e){"first-contentful-paint"===e.name&&t(e.startTime)}))})).observe({type:"paint",buffered:!0})})),r=new Promise((function(t,e){new PerformanceObserver((function(e){var n=e.getEntries(),r=n[n.length-1];t(r.startTime)})).observe({type:"largest-contentful-paint",buffered:!0})})),o=new Promise((function(t,e){new PerformanceObserver((function(e){e.getEntries().forEach((function(e){if("navigation"===e.entryType){var n=e.toJSON();t(n)}}))})).observe({entryTypes:["navigation"]})}));Promise.all([o,r,n]).then((function(e){var n=e[0],r=e[1],o=e[2],a=t.formatTiming(n);t.report({runTime:"immediately",data:{eid:"1000",l:i(i({},a),{lcp:Number(r.toFixed(2)),fcp:Number(o.toFixed(2))})}})}))}else window.addEventListener("load",(function(){var n=performance.timing,r=n.unloadEventStart,o=n.unloadEventEnd,i=n.navigationStart,a=n.redirectStart,s=n.redirectEnd,u=n.fetchStart,l=n.domainLookupStart,c=n.domainLookupEnd,d=n.connectStart,p=n.secureConnectionStart,f=n.connectEnd,v=n.requestStart,h=n.responseStart,m=n.responseEnd,y=n.domLoading,g=n.domInteractive,E=n.domContentLoadedEventEnd,b=n.domContentLoadedEventStart,w=n.domComplete,S=n.loadEventStart,x=n.loadEventEnd,L=performance.navigation.redirectCount,k=i||0;r=r>=k?r-k:0,o=o>=k?o-k:r,a=a>=k?a-k:o,s=s>=k?s-k:a,u=u>=k?u-k:s,c=(l=l>=k?l-k:u)>=k?l-k:l,d=d>=k?d-k:c,p=p>=k?p-k:d,f=f>=k?f-k:p,v=v?v-k:f,h=h>=k?h-k:v,m=m>=k?m-k:h,y=y>=k?y-k:m,g=g>=k?g-k:y,b=b>=k?b-k:g,e={navigationStart:0,unloadEventStart:r,unloadEventEnd:o,redirectStart:a,redirectEnd:s,fetchStart:u,domainLookupStart:l,domainLookupEnd:c,connectStart:d,secureConnectionStart:p,connectEnd:f,requestStart:v,responseStart:h,responseEnd:m,domLoading:y,domInteractive:g,domContentLoadedEventEnd:E=E>=k?E-k:b,domContentLoadedEventStart:b,domComplete:w=w>=k?w-k:E,loadEventStart:S=S>=k?S-k:w,loadEventEnd:x=x>=k?x-k:S,redirectCount:L},t.report({runTime:"immediately",data:{eid:"1000",l:e}})}))},t.prototype.formatTiming=function(t){var e={unloadEventStart:t.unloadEventStart,unloadEventEnd:t.unloadEventEnd,navigationStart:t.navigationStart,redirectStart:t.redirectStart,redirectEnd:t.redirectEnd,redirectCount:t.redirectCount,fetchStart:t.fetchStart,domainLookupStart:t.domainLookupStart,domainLookupEnd:t.domainLookupEnd,connectStart:t.connectStart,secureConnectionStart:t.secureConnectionStart,connectEnd:t.connectEnd,requestStart:t.requestStart,responseStart:t.responseStart,responseEnd:t.responseEnd,domLoading:t.domLoading,domInteractive:t.domInteractive,domContentLoadedEventEnd:t.domContentLoadedEventEnd,domContentLoadedEventStart:t.domContentLoadedEventStart,domComplete:t.domComplete,loadEventStart:t.loadEventStart,loadEventEnd:t.loadEventEnd};return Object.entries(e).forEach((function(t){var n=t[0],r=t[1];e[n]="number"==typeof r?Number(r.toFixed(2)):r||0})),e},t}();t.Browser=b,t.default=E,Object.defineProperty(t,"__esModule",{value:!0})}));
