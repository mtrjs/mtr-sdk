!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports):"function"==typeof define&&define.amd?define(["exports"],e):e((t="undefined"!=typeof globalThis?globalThis:t||self).monitor={})}(this,(function(t){"use strict";function e(t){return e="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},e(t)}function n(t,e){for(var n=0;n<e.length;n++){var o=e[n];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(t,r(o.key),o)}}function o(t,e,n){return(e=r(e))in t?Object.defineProperty(t,e,{value:n,enumerable:!0,configurable:!0,writable:!0}):t[e]=n,t}function r(t){var e=function(t,e){if("object"!=typeof t||null===t)return t;var n=t[Symbol.toPrimitive];if(void 0!==n){var o=n.call(t,e||"default");if("object"!=typeof o)return o;throw new TypeError("@@toPrimitive must return a primitive value.")}return("string"===e?String:Number)(t)}(t,"string");return"symbol"==typeof e?e:String(e)}function i(t){return function(e,n,o){return e[t]=o.value,o}}var a=function(t,n,o,r){var i,a=arguments.length,s=a<3?n:null===r?r=Object.getOwnPropertyDescriptor(n,o):r;if("object"===("undefined"==typeof Reflect?"undefined":e(Reflect))&&"function"==typeof Reflect.decorate)s=Reflect.decorate(t,n,o,r);else for(var d=t.length-1;d>=0;d--)(i=t[d])&&(s=(a<3?i(s):a>3?i(n,o,s):i(n,o))||s);return a>3&&s&&Object.defineProperty(n,o,s),s},s=function(){function t(){!function(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}(this,t),o(this,"lastEmittedEvents",new Map),o(this,"eventListeners",new Map)}var e,r,i;return e=t,r=[{key:"addListener",value:function(t,e){var n=arguments.length>2&&void 0!==arguments[2]&&arguments[2];if(t&&e){var o=this.eventListeners.get(t);o||(o=[],this.eventListeners.set(t,o)),o.indexOf(e)>=0||(o.push(e),n&&this.lastEmittedEvents.has(t)&&e(this.lastEmittedEvents.get(t)))}}},{key:"addOnceListener",value:function(t,e){var n=this,o=arguments.length>2&&void 0!==arguments[2]&&arguments[2];this.on(t,(function o(r){e(r),n.off(t,o)}),o)}},{key:"removeListener",value:function(t,e){if(t)if(e){for(var n=this.listeners(t),o=0;o<n.length;o++)if(n[o]===e){n.splice(o,1);break}}else this.eventListeners.set(t,[]);else this.removeAllListeners()}},{key:"removeAllListeners",value:function(){this.lastEmittedEvents.clear(),this.eventListeners.clear()}},{key:"emit",value:function(t,e){if(t){for(var n=this.listeners(t),o=n.length;o;)(0,n[n.length-o])(e),o--;this.lastEmittedEvents.set(t,e)}}},{key:"listeners",value:function(t){return this.eventListeners.get(t)||[]}},{key:"listenerCount",value:function(t){return this.listeners(t).length}}],r&&n(e.prototype,r),i&&n(e,i),Object.defineProperty(e,"prototype",{writable:!1}),t}();a([i("on")],s.prototype,"addListener",null),a([i("once")],s.prototype,"addOnceListener",null),a([i("off")],s.prototype,"removeListener",null),a([i("offAll")],s.prototype,"removeAllListeners",null),a([i("fire")],s.prototype,"emit",null);var d=window.__globalEvent__;d||(window.__globalEvent__=new s,d=window.__globalEvent__);var u=function(){return u=Object.assign||function(t){for(var e,n=1,o=arguments.length;n<o;n++)for(var r in e=arguments[n])Object.prototype.hasOwnProperty.call(e,r)&&(t[r]=e[r]);return t},u.apply(this,arguments)};var c,l,p,f={name:"monitor",version:"1.0.0",description:"",main:"monitor.min.js",scripts:{build:"rollup -c","build:watch":"rollup -c --watch"},repository:{type:"git",url:"git+https://github.com/xjq7/monitor.git"},keywords:[],author:"",license:"ISC",bugs:{url:"https://github.com/xjq7/monitor/issues"},homepage:"https://github.com/xjq7/monitor#readme",devDependencies:{"@babel/core":"^7.21.0","@babel/preset-env":"^7.20.2","@babel/preset-typescript":"^7.21.0","@rollup/plugin-babel":"^6.0.3","@rollup/plugin-json":"^6.0.0","@rollup/plugin-node-resolve":"^15.0.1","@rollup/plugin-terser":"^0.4.0","@rollup/plugin-typescript":"^11.0.0","@types/node":"^18.14.2","cross-env":"^7.0.3",prettier:"^2.8.4",rimraf:"^4.1.2",rollup:"^3.17.3","rollup-plugin-clear":"^2.0.7",tslib:"^2.5.0",typescript:"^4.9.5"},dependencies:{"@tubit/common":"^1.5.1",jest:"^29.4.3"}},v=function(){function t(t){var e=t.appId,n=Math.random().toString(36).slice(2)+(new Date).getTime().toString(36);this.cache=new Map,this.baseData={appId:e,traceId:n,sdk:{version:f.version}}}return t.prototype.build=function(t){return u(u({t:+new Date},this.baseData),t)},t}(),m=0,h=function(){function t(t){this.pending=!1,this.client=t.client,this.tasks=[],this.max=t.max||10}return t.prototype.consumer=function(){var t=this;if(!(this.tasks.length<this.max||this.pending)){var e=this.client.config.dsn;this.pending=!0,this.client.$hook.emit("send",(function(n){var o=t.tasks.slice(0,t.max).map((function(t){return t.data}));console.log("send 任务发送: 数据",{data:o}),n(e+"/v1/report",{data:o}).then((function(){console.log("send 成功, 清除成功任务"),t.tasks=t.tasks.slice(t.max),t.consumer()})).finally((function(){t.pending=!1}))}))}},t.prototype.push=function(t){var e={id:++m,data:t};this.tasks.push(e),this.consumer()},t.prototype.clear=function(){this.consumer()},t.prototype.immediate=function(t){},t}();!function(t){t.PERFORMANCE="1",t.RESOURCE="2",t.ERROR="3"}(c||(c={})),function(t){t[t.PROMISE=0]="PROMISE",t[t.JS=1]="JS",t[t.RESOURCE=2]="RESOURCE"}(l||(l={})),function(t){t[t.fetch=0]="fetch",t[t.XHR=1]="XHR"}(p||(p={}));var y=function(){function t(t){this.name="Browser",this.options=t||{}}return t.prototype.apply=function(t){var e=this;this.client=t,window&&(t.$hook.on("init",(function(){console.log("init 事件触发"),e.timing(),e.listenError(),e.promiseError(),e.overrideFetch(),e.overrideXHR()})),t.$hook.on("send",(function(t){t(e.send)})),window.addEventListener("unload",(function(){t.$hook.emit("report",{})})))},t.prototype.send=function(t,e){var n=e.data,o=new FormData;return o.append("data",JSON.stringify(n)),"function"==typeof navigator.sendBeacon?Promise.resolve(navigator.sendBeacon(t,o)):new Promise((function(e,n){var r=new XMLHttpRequest;r.addEventListener("load",(function(){e(!0)})),r.addEventListener("error",(function(){n()})),r.open("POST",t),r.send(o)}))},t.prototype.report=function(t){var e,n=t.eid,o=t.l,r=navigator.userAgent;null===(e=this.client)||void 0===e||e.$hook.emit("report",{eid:n,l:u(u({},o),{ua:r})})},t.prototype.overrideXHR=function(){var t=this.client;if(XMLHttpRequest){var e=XMLHttpRequest.prototype.open,n=XMLHttpRequest.prototype.send;XMLHttpRequest.prototype.open=function(){for(var t=[],n=0;n<arguments.length;n++)t[n]=arguments[n];var o=t[0],r=t[1],i=Date.now();this.monitorCollect=u(u({},this.monitorCollect),{method:o,url:r,startTime:i,type:p.XHR}),e.apply(this,t)},XMLHttpRequest.prototype.send=function(){for(var e=this,o=[],r=0;r<arguments.length;r++)o[r]=arguments[r];this.addEventListener("loadend",(function(){var n=Date.now(),o=e,r=o.status,i=o.statusText;r>200&&(e.monitorCollect=u(u({},e.monitorCollect),{endTime:n,status:r,statusText:i}),null==t||t.$hook.emit("report",{eid:"1001",l:e.monitorCollect}))})),n.apply(this,o)}}},t.prototype.overrideFetch=function(){if("function"==typeof window.fetch){var t=this,e=window.fetch;window.fetch=function(){for(var n=[],o=0;o<arguments.length;o++)n[o]=arguments[o];var r=Date.now(),i=n[0],a=(n[1]||{}).method,s={url:i,startTime:r,method:void 0===a?"GET":a,type:p.fetch};return e.apply(window,n).then((function(e){var n=e.status,o=e.statusText;if(n&&n>300){var r=Date.now();Object.assign(s,{status:n,statusText:o,endTime:r}),t.report({eid:"1001",l:s})}return e})).catch((function(e){var n=Date.now(),o=e.name,r=e.message,i=e.stack;return Object.assign(s,{name:o,message:r,stack:i}),s.endTime=n,t.report({eid:"1001",l:s}),e}))}}},t.prototype.listenError=function(){var t=this;window.addEventListener("error",(function(e){var n=e.type,o=e.error,r=e.colno,i=e.filename,a=e.lineno,s=e.message;"error"===n&&i&&r&&a&&(s||(s=(null==o?void 0:o.message)||""),t.report({eid:"1003",l:{colno:r,message:s,filename:i,lineno:a,stack:null==o?void 0:o.stack,type:l.JS}}))}),!0)},t.prototype.promiseError=function(){var t=this;window.addEventListener("unhandledrejection",(function(e){var n=e.reason,o={message:"",stack:"",name:""};if("string"==typeof n)o.message=n;else if(n instanceof Error){var r=n.name,i=n.stack,a=n.message;o.message=a,o.stack=i||"",o.name=r}t.report({eid:"1003",l:u({type:l.PROMISE},o)})}))},t.prototype.timing=function(){var t=this,e={};if(PerformanceObserver){var n=new Promise((function(t,e){new PerformanceObserver((function(e){e.getEntries().forEach((function(e){"first-contentful-paint"===e.name&&t(e.startTime)}))})).observe({type:"paint",buffered:!0})})),o=new Promise((function(t,e){new PerformanceObserver((function(e){var n=e.getEntries(),o=n[n.length-1];t(o.startTime)})).observe({type:"largest-contentful-paint",buffered:!0})})),r=new Promise((function(t,e){new PerformanceObserver((function(e){e.getEntries().forEach((function(e){if("navigation"===e.entryType){var n=e.toJSON();t(n)}}))})).observe({entryTypes:["navigation"]})}));Promise.all([r,o,n]).then((function(e){var n=e[0],o=e[1],r=e[2],i=t.formatTiming(n);t.report({eid:"1000",l:u(u({},i),{lcp:Number(o.toFixed(2)),fcp:Number(r.toFixed(2))})})}))}else window.addEventListener("load",(function(){var n=performance.timing,o=n.unloadEventStart,r=n.unloadEventEnd,i=n.navigationStart,a=n.redirectStart,s=n.redirectEnd,d=n.fetchStart,u=n.domainLookupStart,c=n.domainLookupEnd,l=n.connectStart,p=n.secureConnectionStart,f=n.connectEnd,v=n.requestStart,m=n.responseStart,h=n.responseEnd,y=n.domLoading,E=n.domInteractive,g=n.domContentLoadedEventEnd,b=n.domContentLoadedEventStart,S=n.domComplete,w=n.loadEventStart,L=n.loadEventEnd,k=performance.navigation.redirectCount,C=i||0;o=o>=C?o-C:0,r=r>=C?r-C:o,a=a>=C?a-C:r,s=s>=C?s-C:a,d=d>=C?d-C:s,c=(u=u>=C?u-C:d)>=C?u-C:u,l=l>=C?l-C:c,p=p>=C?p-C:l,f=f>=C?f-C:p,v=v?v-C:f,m=m>=C?m-C:v,h=h>=C?h-C:m,y=y>=C?y-C:h,E=E>=C?E-C:y,b=b>=C?b-C:E,e={navigationStart:0,unloadEventStart:o,unloadEventEnd:r,redirectStart:a,redirectEnd:s,fetchStart:d,domainLookupStart:u,domainLookupEnd:c,connectStart:l,secureConnectionStart:p,connectEnd:f,requestStart:v,responseStart:m,responseEnd:h,domLoading:y,domInteractive:E,domContentLoadedEventEnd:g=g>=C?g-C:b,domContentLoadedEventStart:b,domComplete:S=S>=C?S-C:g,loadEventStart:w=w>=C?w-C:S,loadEventEnd:L=L>=C?L-C:w,redirectCount:k},t.report({eid:"1000",l:e})}))},t.prototype.formatTiming=function(t){var e={unloadEventStart:t.unloadEventStart,unloadEventEnd:t.unloadEventEnd,navigationStart:t.navigationStart,redirectStart:t.redirectStart,redirectEnd:t.redirectEnd,redirectCount:t.redirectCount,fetchStart:t.fetchStart,domainLookupStart:t.domainLookupStart,domainLookupEnd:t.domainLookupEnd,connectStart:t.connectStart,secureConnectionStart:t.secureConnectionStart,connectEnd:t.connectEnd,requestStart:t.requestStart,responseStart:t.responseStart,responseEnd:t.responseEnd,domLoading:t.domLoading,domInteractive:t.domInteractive,domContentLoadedEventEnd:t.domContentLoadedEventEnd,domContentLoadedEventStart:t.domContentLoadedEventStart,domComplete:t.domComplete,loadEventStart:t.loadEventStart,loadEventEnd:t.loadEventEnd};return Object.entries(e).forEach((function(t){var n=t[0],o=t[1];e[n]="number"==typeof o?Number(o.toFixed(2)):o||0})),e},t}();var E=function(){function t(){}return t.prototype.init=function(t){var e;!function(t){if(!t)throw new Error("缺少 SDK 配置信息");if(!t.dsn)throw new Error("缺少 SDK dns 配置信息");if(!t.appId)throw new Error("缺少 appId 应用 ID")}(t),this.config=t;var n=t.plugins,o=void 0===n?[]:n,r=t.appId;this.builder=new v({appId:r}),this.schedule=new h({max:2,client:this}),this.$hook=new s,this.registerPlugins(o),this.addListeners(),null===(e=this.$hook)||void 0===e||e.emit("init",{})},t.prototype.registerPlugins=function(t){var e=this;Array.isArray(t)&&t.map((function(t){return t.apply(e)}))},t.prototype.addListeners=function(){var t,e=this;null===(t=this.$hook)||void 0===t||t.on("report",(function(t){var n,o;console.log("report 事件触发, 数据:",t);var r=null===(n=e.builder)||void 0===n?void 0:n.build(t);r&&(null===(o=e.schedule)||void 0===o||o.push(r))}))},t}();t.Browser=y,t.default=E,Object.defineProperty(t,"__esModule",{value:!0})}));
