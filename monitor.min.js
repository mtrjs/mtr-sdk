!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports):"function"==typeof define&&define.amd?define(["exports"],t):t((e="undefined"!=typeof globalThis?globalThis:e||self).monitor={})}(this,(function(e){"use strict";function t(e){return function(t,s,n){return t[e]=n.value,n}}var s=function(e,t,s,n){var i,o=arguments.length,r=o<3?t:null===n?n=Object.getOwnPropertyDescriptor(t,s):n;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)r=Reflect.decorate(e,t,s,n);else for(var l=e.length-1;l>=0;l--)(i=e[l])&&(r=(o<3?i(r):o>3?i(t,s,r):i(t,s))||r);return o>3&&r&&Object.defineProperty(t,s,r),r};class n{lastEmittedEvents=new Map;eventListeners=new Map;addListener(e,t,s=!1){if(!e||!t)return;let n=this.eventListeners.get(e);if(n||(n=[],this.eventListeners.set(e,n)),!(n.indexOf(t)>=0)&&(n.push(t),s&&this.lastEmittedEvents.has(e))){t(this.lastEmittedEvents.get(e))}}addOnceListener(e,t,s=!1){const n=s=>{t(s),this.off(e,n)};this.on(e,n,s)}removeListener(e,t){if(!e)return void this.removeAllListeners();if(!t)return void this.eventListeners.set(e,[]);const s=this.listeners(e);for(let e=0;e<s.length;e++){if(s[e]===t){s.splice(e,1);break}}}removeAllListeners(){this.lastEmittedEvents.clear(),this.eventListeners.clear()}emit(e,t){if(!e)return;const s=this.listeners(e);let n=s.length;for(;n;){(0,s[s.length-n])(t),n--}this.lastEmittedEvents.set(e,t)}listeners(e){return this.eventListeners.get(e)||[]}listenerCount(e){return this.listeners(e).length}}s([t("on")],n.prototype,"addListener",null),s([t("once")],n.prototype,"addOnceListener",null),s([t("off")],n.prototype,"removeListener",null),s([t("offAll")],n.prototype,"removeAllListeners",null),s([t("fire")],n.prototype,"emit",null);let{__globalEvent__:i}=window;i||(window.__globalEvent__=new n,i=window.__globalEvent__);var o="1.0.0";class r{baseData;constructor(e){const{appId:t}=e,s=Math.random().toString(36).slice(2)+(new Date).getTime().toString(36);this.baseData={appId:t,traceId:s,sdk:{version:o}}}build(e){const{l:t,type:s}=e;return Object.assign({l:t,type:s},this.baseData)}}var l;!function(e){e.PERFORMANCE="1",e.RESOURCE="2",e.ERROR="3"}(l||(l={}));class a{tasks;max;client;pending=!1;constructor(e){this.client=e.client,this.tasks=[],this.max=e.max||10}consumer(){this.tasks.length<this.max||this.pending||(this.pending=!0,this.client.$hook.emit("send",(e=>{const t=this.tasks.slice(0,this.max);console.log("send 任务发送: 数据",t),e("",t).then((()=>{console.log("send 成功, 清除成功任务"),this.tasks=this.tasks.slice(this.max),this.consumer()})).finally((()=>{this.pending=!1}))})))}push(e){this.tasks.push(e),this.consumer()}immediate(e){}}e.Browser=class{options;name="Browser";constructor(e){this.options=e||{}}apply(e){e.$hook.on("init",(()=>{console.log("init 事件触发"),this.timing(e),this.jsError(e),this.promiseError(e)})),e.$hook.on("send",(e=>{e(this.send)}))}send(e,t){if("function"==typeof navigator.sendBeacon)return Promise.resolve(navigator.sendBeacon(e,JSON.stringify(t)))}jsError(e){window.onerror=(t,s,n,i,o)=>{e.$hook.emit("report",{type:l.ERROR,l:{source:s,lineno:n}})}}promiseError(e){window.addEventListener("unhandledrejection",(e=>{console.log(e)}))}timing(e){let t={};if(PerformanceObserver){new PerformanceObserver((e=>{e.getEntries().forEach((e=>{const{entryType:s}=e;if("navigation"===s){const s=e.toJSON();Object.assign(t,s)}}))})).observe({entryTypes:["navigation"]})}else Object.assign(t,performance.navigation,performance.timing);e.$hook.emit("report",{type:l.PERFORMANCE,l:t})}},e.default=class{$hook;options;builder;schedule;constructor(e){this.options=e;const{plugins:t=[],appId:s}=e;this.$hook=new n,this.builder=new r({appId:s}),this.schedule=new a({max:10,client:this}),this.registerPlugins(t),this.addListeners(),this.$hook.emit("init",{})}registerPlugins(e){Array.isArray(e)&&e.map((e=>e.apply(this)))}addListeners(){this.$hook.on("report",(e=>{console.log("report 事件触发, 数据:",e);const t=this.builder.build(e);this.schedule.push(t)}))}},Object.defineProperty(e,"__esModule",{value:!0})}));
