!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports):"function"==typeof define&&define.amd?define(["exports"],t):t((e="undefined"!=typeof globalThis?globalThis:e||self).monitor={})}(this,(function(e){"use strict";function t(e){return t="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},t(e)}function n(e,t){for(var n=0;n<t.length;n++){var o=t[n];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(e,i(o.key),o)}}function o(e,t,n){return(t=i(t))in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function i(e){var t=function(e,t){if("object"!=typeof e||null===e)return e;var n=e[Symbol.toPrimitive];if(void 0!==n){var o=n.call(e,t||"default");if("object"!=typeof o)return o;throw new TypeError("@@toPrimitive must return a primitive value.")}return("string"===t?String:Number)(e)}(e,"string");return"symbol"==typeof t?t:String(t)}function r(e){return function(t,n,o){return t[e]=o.value,o}}var s=function(e,n,o,i){var r,s=arguments.length,l=s<3?n:null===i?i=Object.getOwnPropertyDescriptor(n,o):i;if("object"===("undefined"==typeof Reflect?"undefined":t(Reflect))&&"function"==typeof Reflect.decorate)l=Reflect.decorate(e,n,o,i);else for(var u=e.length-1;u>=0;u--)(r=e[u])&&(l=(s<3?r(l):s>3?r(n,o,l):r(n,o))||l);return s>3&&l&&Object.defineProperty(n,o,l),l},l=function(){function e(){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),o(this,"lastEmittedEvents",new Map),o(this,"eventListeners",new Map)}var t,i,r;return t=e,i=[{key:"addListener",value:function(e,t){var n=arguments.length>2&&void 0!==arguments[2]&&arguments[2];if(e&&t){var o=this.eventListeners.get(e);o||(o=[],this.eventListeners.set(e,o)),o.indexOf(t)>=0||(o.push(t),n&&this.lastEmittedEvents.has(e)&&t(this.lastEmittedEvents.get(e)))}}},{key:"addOnceListener",value:function(e,t){var n=this,o=arguments.length>2&&void 0!==arguments[2]&&arguments[2];this.on(e,(function o(i){t(i),n.off(e,o)}),o)}},{key:"removeListener",value:function(e,t){if(e)if(t){for(var n=this.listeners(e),o=0;o<n.length;o++)if(n[o]===t){n.splice(o,1);break}}else this.eventListeners.set(e,[]);else this.removeAllListeners()}},{key:"removeAllListeners",value:function(){this.lastEmittedEvents.clear(),this.eventListeners.clear()}},{key:"emit",value:function(e,t){if(e){for(var n=this.listeners(e),o=n.length;o;)(0,n[n.length-o])(t),o--;this.lastEmittedEvents.set(e,t)}}},{key:"listeners",value:function(e){return this.eventListeners.get(e)||[]}},{key:"listenerCount",value:function(e){return this.listeners(e).length}}],i&&n(t.prototype,i),r&&n(t,r),Object.defineProperty(t,"prototype",{writable:!1}),e}();s([r("on")],l.prototype,"addListener",null),s([r("once")],l.prototype,"addOnceListener",null),s([r("off")],l.prototype,"removeListener",null),s([r("offAll")],l.prototype,"removeAllListeners",null),s([r("fire")],l.prototype,"emit",null);var u=window.__globalEvent__;u||(window.__globalEvent__=new l,u=window.__globalEvent__);var a,p={name:"monitor",version:"1.0.0",description:"",main:"monitor.min.js",scripts:{build:"rollup -c","build:watch":"rollup -c --watch",serve:"nodemon web/server.ts"},repository:{type:"git",url:"git+https://github.com/xjq7/monitor.git"},keywords:[],author:"",license:"ISC",bugs:{url:"https://github.com/xjq7/monitor/issues"},homepage:"https://github.com/xjq7/monitor#readme",devDependencies:{"@babel/core":"^7.21.0","@babel/preset-env":"^7.20.2","@babel/preset-typescript":"^7.21.0","@rollup/plugin-babel":"^6.0.3","@rollup/plugin-json":"^6.0.0","@rollup/plugin-node-resolve":"^15.0.1","@rollup/plugin-terser":"^0.4.0","@rollup/plugin-typescript":"^11.0.0","@types/node":"^18.14.2","cross-env":"^7.0.3",prettier:"^2.8.4",rimraf:"^4.1.2",rollup:"^3.17.3","rollup-plugin-clear":"^2.0.7",tslib:"^2.5.0",typescript:"^4.9.5"},dependencies:{"@tubit/common":"^1.5.1",jest:"^29.4.3"}},c=function(){function e(e){var t=e.appId,n=Math.random().toString(36).slice(2)+(new Date).getTime().toString(36);this.baseData={appId:t,traceId:n,sdk:{version:p.version}}}return e.prototype.build=function(e){var t=e.l,n=e.type;return Object.assign({l:t,type:n,t:+new Date},this.baseData)},e}();!function(e){e.PERFORMANCE="1",e.RESOURCE="2",e.ERROR="3"}(a||(a={}));var f=0,d=function(){function e(e){this.pending=!1,this.client=e.client,this.tasks=[],this.max=e.max||10}return e.prototype.consumer=function(){var e=this;this.tasks.length<this.max||this.pending||(this.pending=!0,this.client.$hook.emit("send",(function(t){var n=e.tasks.slice(0,e.max).map((function(e){return e.data}));console.log("send 任务发送: 数据",n),t("",n).then((function(){console.log("send 成功, 清除成功任务"),e.tasks=e.tasks.slice(e.max),e.consumer()})).finally((function(){e.pending=!1}))})))},e.prototype.push=function(e){var t={id:++f,data:e};this.tasks.push(t),this.consumer()},e.prototype.clear=function(){},e.prototype.immediate=function(e){},e}(),h=function(){function e(e){this.name="Browser",this.options=e||{}}return e.prototype.apply=function(e){var t=this;e.$hook.on("init",(function(){console.log("init 事件触发"),t.timing(e),t.jsError(e),t.promiseError(e)})),e.$hook.on("send",(function(e){e(t.send)})),window.addEventListener("unload",(function(){e.$hook.emit("report",{})}))},e.prototype.send=function(e,t){if("function"==typeof navigator.sendBeacon)return Promise.resolve(navigator.sendBeacon(e,JSON.stringify(t)))},e.prototype.jsError=function(e){window.onerror=function(t,n,o,i,r){e.$hook.emit("report",{type:a.ERROR,l:{source:n,lineno:o}})}},e.prototype.promiseError=function(e){window.addEventListener("unhandledrejection",(function(e){e.reason,console.log(e)}))},e.prototype.timing=function(e){var t={};if(PerformanceObserver){new PerformanceObserver((function(e){e.getEntries().forEach((function(e){if("navigation"===e.entryType){var n=e.toJSON();Object.assign(t,n)}}))})).observe({entryTypes:["navigation"]})}else Object.assign(t,performance.navigation,performance.timing);e.$hook.emit("report",{type:a.PERFORMANCE,l:t})},e}(),v=function(){function e(e){this.options=e;var t=e.plugins,n=void 0===t?[]:t,o=e.appId;this.$hook=new l,this.builder=new c({appId:o}),this.schedule=new d({max:10,client:this}),this.registerPlugins(n),this.addListeners(),this.$hook.emit("init",{})}return e.prototype.registerPlugins=function(e){var t=this;Array.isArray(e)&&e.map((function(e){return e.apply(t)}))},e.prototype.addListeners=function(){var e=this;this.$hook.on("report",(function(t){console.log("report 事件触发, 数据:",t);var n=e.builder.build(t);n&&e.schedule.push(n)}))},e}();e.Browser=h,e.default=v,Object.defineProperty(e,"__esModule",{value:!0})}));
